{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"zoo-template-common","text":"<p>Welcome to the documentation for zoo-template-common, a Python package providing common execution handlers and utilities for ZOO-Project CWL workflow templates.</p>"},{"location":"#overview","title":"Overview","text":"<p>This package provides a simple, extensible base class (<code>CommonExecutionHandler</code>) for handling CWL workflow execution in ZOO-Project templates. It includes basic functionality for STAC catalog processing, pod configuration, and output management.</p>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li> <p>CommonExecutionHandler: Base class for CWL workflow execution handlers</p> <ul> <li>Pre/post execution hooks</li> <li>STAC catalog output processing</li> <li>Pod environment variable and node selector management</li> <li>Secrets handling</li> <li>Tool log management</li> </ul> </li> <li> <p>CustomStacIO: STAC I/O class for S3 operations using boto3</p> <ul> <li>Read/write STAC catalogs from/to S3</li> <li>Support for both S3 and local file systems</li> </ul> </li> </ul>"},{"location":"#quick-example","title":"Quick Example","text":"<pre><code>from zoo_template_common import CommonExecutionHandler\nfrom zoo_calrissian_runner import ZooCalrissianRunner\n\ndef my_workflow(conf, inputs, outputs):\n    execution_handler = CommonExecutionHandler(conf=conf, outputs=outputs)\n\n    runner = ZooCalrissianRunner(\n        cwl=cwl,\n        conf=conf,\n        inputs=inputs,\n        outputs=outputs,\n        execution_handler=execution_handler,\n    )\n\n    exit_status = runner.execute()\n    return exit_status\n</code></pre>"},{"location":"#templates-using-this-package","title":"Templates Using This Package","text":"<ul> <li>eoepca-proc-service-template: Extends CommonExecutionHandler with EOEPCA Workspace API integration</li> <li>zoo-service-template (EOAP): Uses CommonExecutionHandler as-is or extends it</li> </ul>"},{"location":"#installation","title":"Installation","text":"<pre><code>pip install zoo-template-common\n</code></pre> <p>Or from Git: <pre><code>pip install git+https://github.com/EOEPCA/zoo-template-common.git@main\n</code></pre></p>"},{"location":"#next-steps","title":"Next Steps","text":"<ul> <li>Quick Start Guide</li> <li>Basic Usage</li> <li>Extending the Handler</li> <li>Complete Examples</li> <li>API Reference</li> </ul>"},{"location":"contributing/","title":"Contributing to zoo-template-common","text":"<p>Thank you for your interest in contributing to zoo-template-common! This document provides guidelines for contributing to the project.</p>"},{"location":"contributing/#getting-started","title":"Getting Started","text":""},{"location":"contributing/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.8 or higher</li> <li>Git</li> <li>Poetry (recommended) or pip</li> </ul>"},{"location":"contributing/#development-setup","title":"Development Setup","text":"<ol> <li>Fork and Clone</li> </ol> <pre><code>git clone https://github.com/YOUR-USERNAME/zoo-template-common.git\ncd zoo-template-common\n</code></pre> <ol> <li>Create Virtual Environment</li> </ol> <pre><code>python -m venv venv\nsource venv/bin/activate  # On Windows: venv\\Scripts\\activate\n</code></pre> <ol> <li>Install Dependencies</li> </ol> <p>With Poetry: <pre><code>poetry install\n</code></pre></p> <p>Or with pip: <pre><code>pip install -e \".[dev]\"\n</code></pre></p> <ol> <li>Verify Installation</li> </ol> <pre><code>python -c \"from zoo_template_common import CommonExecutionHandler; print('OK')\"\n</code></pre>"},{"location":"contributing/#development-workflow","title":"Development Workflow","text":""},{"location":"contributing/#1-create-a-branch","title":"1. Create a Branch","text":"<pre><code>git checkout -b feature/your-feature-name\n</code></pre> <p>Use prefixes: - <code>feature/</code> - New features - <code>fix/</code> - Bug fixes - <code>docs/</code> - Documentation updates - <code>refactor/</code> - Code refactoring</p>"},{"location":"contributing/#2-make-changes","title":"2. Make Changes","text":"<p>Follow the coding standards:</p> <ul> <li>PEP 8: Follow Python style guide</li> <li>Type Hints: Use type annotations</li> <li>Docstrings: Google-style docstrings</li> <li>Comments: Explain complex logic</li> </ul> <p>Example:</p> <pre><code>def get_pod_env_vars(self) -&gt; dict:\n    \"\"\"\n    Get environment variables for pod execution.\n\n    Returns:\n        dict: Environment variables to set in the execution pod.\n            Keys are variable names, values are variable values.\n\n    Example:\n        &gt;&gt;&gt; handler = CommonExecutionHandler(conf)\n        &gt;&gt;&gt; env = handler.get_pod_env_vars()\n        &gt;&gt;&gt; print(env[\"MY_VAR\"])\n        'value'\n    \"\"\"\n    return {}\n</code></pre>"},{"location":"contributing/#3-write-tests","title":"3. Write Tests","text":"<p>Add tests for new features:</p> <pre><code># tests/test_my_feature.py\nimport pytest\nfrom zoo_template_common import CommonExecutionHandler\n\ndef test_my_feature():\n    \"\"\"Test my new feature\"\"\"\n    conf = {\"lenv\": {\"message\": \"\"}}\n    handler = CommonExecutionHandler(conf)\n\n    # Test your feature\n    result = handler.my_feature()\n    assert result == expected_value\n</code></pre> <p>Run tests:</p> <pre><code>pytest tests/\n</code></pre>"},{"location":"contributing/#4-update-documentation","title":"4. Update Documentation","text":"<ul> <li>Update docstrings</li> <li>Update relevant <code>.md</code> files in <code>docs/</code></li> <li>Add examples if applicable</li> </ul>"},{"location":"contributing/#5-commit-changes","title":"5. Commit Changes","text":"<p>Write clear commit messages:</p> <pre><code>git add .\ngit commit -m \"Add feature: description of feature\"\n</code></pre> <p>Good commit message format: <pre><code>&lt;type&gt;: &lt;short summary&gt;\n\n&lt;detailed description if needed&gt;\n\n&lt;issue reference if applicable&gt;\n</code></pre></p> <p>Types: - <code>feat</code>: New feature - <code>fix</code>: Bug fix - <code>docs</code>: Documentation - <code>style</code>: Formatting - <code>refactor</code>: Code restructuring - <code>test</code>: Adding tests - <code>chore</code>: Maintenance</p>"},{"location":"contributing/#6-push-and-create-pr","title":"6. Push and Create PR","text":"<pre><code>git push origin feature/your-feature-name\n</code></pre> <p>Create a Pull Request on GitHub with: - Clear title and description - Reference related issues - List changes made - Add screenshots if UI-related</p>"},{"location":"contributing/#code-standards","title":"Code Standards","text":""},{"location":"contributing/#python-style","title":"Python Style","text":"<pre><code># Good\ndef get_secrets(self) -&gt; dict:\n    \"\"\"Load secrets from configuration files.\"\"\"\n    secrets = {}\n    for path in self.SECRET_PATHS:\n        if os.path.exists(path):\n            secrets.update(self.local_get_file(path))\n    return secrets\n\n# Bad\ndef get_secrets(self):\n    s = {}\n    for p in [\"/var/etc/secrets/processing_secrets.yaml\"]:\n        if os.path.exists(p):\n            s.update(self.local_get_file(p))\n    return s\n</code></pre>"},{"location":"contributing/#type-hints","title":"Type Hints","text":"<pre><code>from typing import Dict, List, Optional\n\ndef process_items(self, items: List[str]) -&gt; Dict[str, int]:\n    \"\"\"Process list of items.\"\"\"\n    pass\n\ndef get_config(self) -&gt; Optional[Dict[str, any]]:\n    \"\"\"Get configuration if available.\"\"\"\n    pass\n</code></pre>"},{"location":"contributing/#error-handling","title":"Error Handling","text":"<pre><code># Good\ndef load_file(self, path: str) -&gt; dict:\n    \"\"\"Load YAML file.\"\"\"\n    try:\n        with open(path) as f:\n            return yaml.safe_load(f)\n    except FileNotFoundError:\n        self.logger.warning(f\"File not found: {path}\")\n        return {}\n    except yaml.YAMLError as e:\n        self.logger.error(f\"Invalid YAML: {e}\")\n        raise\n\n# Bad\ndef load_file(self, path):\n    with open(path) as f:\n        return yaml.safe_load(f)\n</code></pre>"},{"location":"contributing/#testing-guidelines","title":"Testing Guidelines","text":""},{"location":"contributing/#unit-tests","title":"Unit Tests","text":"<p>Test individual methods:</p> <pre><code>def test_get_pod_env_vars():\n    \"\"\"Test pod environment variables\"\"\"\n    conf = {\"lenv\": {}}\n    handler = CommonExecutionHandler(conf)\n\n    env = handler.get_pod_env_vars()\n\n    assert isinstance(env, dict)\n    assert \"CUSTOM_VAR\" not in env  # Base handler returns empty\n</code></pre>"},{"location":"contributing/#integration-tests","title":"Integration Tests","text":"<p>Test interactions:</p> <pre><code>def test_handler_lifecycle():\n    \"\"\"Test complete handler lifecycle\"\"\"\n    conf = {\"lenv\": {\"message\": \"\"}}\n    outputs = {}\n\n    handler = CommonExecutionHandler(conf, outputs)\n\n    # Pre-execution\n    handler.pre_execution_hook()\n\n    # Execution simulation\n    outputs[\"stac\"] = \"/tmp/catalog.json\"\n\n    # Post-execution\n    handler.post_execution_hook(None, outputs, None, None)\n\n    assert \"message\" in conf[\"lenv\"]\n</code></pre>"},{"location":"contributing/#test-coverage","title":"Test Coverage","text":"<p>Aim for &gt;80% code coverage:</p> <pre><code>pytest --cov=zoo_template_common tests/\n</code></pre>"},{"location":"contributing/#documentation","title":"Documentation","text":""},{"location":"contributing/#docstring-format","title":"Docstring Format","text":"<p>Use Google-style docstrings:</p> <pre><code>def my_method(self, param1: str, param2: int = 0) -&gt; bool:\n    \"\"\"\n    Short description of method.\n\n    Longer description with more details about what the method does,\n    how it works, and any important notes.\n\n    Args:\n        param1: Description of param1\n        param2: Description of param2. Defaults to 0.\n\n    Returns:\n        True if successful, False otherwise.\n\n    Raises:\n        ValueError: If param1 is empty\n        IOError: If file cannot be read\n\n    Example:\n        &gt;&gt;&gt; handler = MyHandler(conf)\n        &gt;&gt;&gt; result = handler.my_method(\"test\", 5)\n        &gt;&gt;&gt; print(result)\n        True\n    \"\"\"\n    pass\n</code></pre>"},{"location":"contributing/#update-documentation","title":"Update Documentation","text":"<p>When adding features:</p> <ol> <li>Update API reference in <code>docs/api-reference/</code></li> <li>Add usage examples to <code>docs/user-guide/</code></li> <li>Update <code>README.md</code> if needed</li> <li>Add to changelog</li> </ol>"},{"location":"contributing/#release-process","title":"Release Process","text":"<ol> <li>Update version in <code>pyproject.toml</code></li> <li>Update <code>CHANGELOG.md</code></li> <li>Create release tag</li> <li>Build and publish to PyPI</li> </ol> <pre><code># Update version\npoetry version patch  # or minor, major\n\n# Build\npoetry build\n\n# Publish (maintainers only)\npoetry publish\n</code></pre>"},{"location":"contributing/#getting-help","title":"Getting Help","text":"<ul> <li>Issues: Open an issue on GitHub</li> <li>Discussions: Use GitHub Discussions</li> <li>Contact: Email the maintainers</li> </ul>"},{"location":"contributing/#code-of-conduct","title":"Code of Conduct","text":"<p>Be respectful and professional:</p> <ul> <li>Be welcoming and inclusive</li> <li>Be respectful of differing viewpoints</li> <li>Accept constructive criticism gracefully</li> <li>Focus on what is best for the community</li> </ul>"},{"location":"contributing/#license","title":"License","text":"<p>By contributing, you agree that your contributions will be licensed under the same license as the project.</p>"},{"location":"contributing/#questions","title":"Questions?","text":"<p>If you have questions about contributing, feel free to:</p> <ul> <li>Open an issue</li> <li>Start a discussion</li> <li>Contact the maintainers</li> </ul> <p>Thank you for contributing! \ud83c\udf89</p>"},{"location":"api-reference/common-execution-handler/","title":"CommonExecutionHandler API Reference","text":""},{"location":"api-reference/common-execution-handler/#zoo_template_common.common_execution_handler.CommonExecutionHandler","title":"<code>CommonExecutionHandler</code>","text":"<p>Simple execution handler for ZOO-Project CWL workflows.</p> <p>This class provides basic functionality for handling CWL workflow execution with STAC catalog output processing. For more specific use cases (e.g., EOEPCA with Workspace API integration), extend this class and override the hooks.</p> Source code in <code>zoo_template_common/common_execution_handler.py</code> <pre><code>class CommonExecutionHandler:\n    \"\"\"Simple execution handler for ZOO-Project CWL workflows.\n\n    This class provides basic functionality for handling CWL workflow execution\n    with STAC catalog output processing. For more specific use cases (e.g., EOEPCA\n    with Workspace API integration), extend this class and override the hooks.\n    \"\"\"\n\n    def __init__(self, conf, outputs=None):\n        self.conf = conf\n        self.outputs = outputs or {}\n        self.results = None\n\n    def pre_execution_hook(self):\n        \"\"\"Hook to run before execution. Override in subclasses for custom behavior.\"\"\"\n        logger.info(\"Pre execution hook\")\n\n    def setOutput(self, outputName, values):\n        \"\"\"Process and set output values from STAC catalog.\"\"\"\n        output = self.outputs[outputName]\n        logger.info(f\"Read catalog from STAC Catalog URI: {output} -&gt; {values}\")\n\n        if not isinstance(values[outputName], list):\n            logger.info(f\"values[{outputName}] is not a list, transform to an array\")\n            values[outputName] = [values[outputName]]\n\n        items = []\n\n        for i in range(len(values[outputName])):\n            if values[outputName][i] is None:\n                break\n            cat: Catalog = read_file(values[outputName][i][\"value\"])\n\n            collection_id = self.get_additional_parameters()[\"sub_path\"]\n            logger.info(f\"Create collection with ID {collection_id}\")\n\n            collection = None\n\n            try:\n                logger.info(f\"Catalog : {dir(cat)}\")\n                collection: Collection = next(cat.get_all_collections())\n            except Exception:\n                logger.error(\"No collection found in the output catalog\")\n                output[\"collection\"] = json.dumps({}, indent=2)\n                return\n\n            logger.info(f\"Got collection {collection.id} from processing outputs\")\n\n            for item in collection.get_all_items():\n                logger.info(f\"Processing item {item.id}\")\n\n                for asset_key in item.assets.keys():\n                    logger.info(f\"Processing asset {asset_key}\")\n\n                    temp_asset = item.assets[asset_key].to_dict()\n                    temp_asset[\"storage:platform\"] = self.get_additional_parameters().get(\n                        \"storage_platform\", \"default\"\n                    )\n                    temp_asset[\"storage:requester_pays\"] = False\n                    temp_asset[\"storage:tier\"] = \"Standard\"\n                    temp_asset[\"storage:region\"] = self.get_additional_parameters().get(\n                        \"region_name\", \"default\"\n                    )\n                    temp_asset[\"storage:endpoint\"] = self.get_additional_parameters().get(\n                        \"endpoint_url\", \"\"\n                    )\n                    item.assets[asset_key] = item.assets[asset_key].from_dict(temp_asset)\n\n                item.collection_id = collection_id\n                items.append(item.clone())\n\n        item_collection = ItemCollection(items=items)\n        logger.info(\"Created feature collection from items\")\n\n        # Trap the case of no output collection\n        if item_collection is None:\n            logger.error(\"The output collection is empty\")\n            output[\"collection\"] = json.dumps({}, indent=2)\n            return\n\n        # Set the feature collection to be returned\n        output[\"collection\"] = item_collection.to_dict()\n        output[\"collection\"][\"id\"] = collection_id\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Hook to run after execution. Sets up S3 environment and processes outputs.\"\"\"\n        # Unset HTTP proxy or else the S3 client will use it and fail\n        os.environ.pop(\"HTTP_PROXY\", None)\n\n        # Set S3 environment variables from additional parameters\n        additional_params = self.get_additional_parameters()\n        os.environ[\"AWS_S3_REGION\"] = additional_params.get(\"region_name\", \"\")\n        os.environ[\"AWS_S3_ENDPOINT\"] = additional_params.get(\"endpoint_url\", \"\")\n        os.environ[\"AWS_ACCESS_KEY_ID\"] = additional_params.get(\"aws_access_key_id\", \"\")\n        os.environ[\"AWS_SECRET_ACCESS_KEY\"] = additional_params.get(\"aws_secret_access_key\", \"\")\n\n        logger.info(\"Post execution hook\")\n\n        from zoo_template_common.custom_stac_io import CustomStacIO\n\n        StacIO.set_default(CustomStacIO)\n\n        for i in self.outputs:\n            logger.info(f\"Output {i}: {self.outputs[i]}\")\n            if \"mimeType\" in self.outputs[i]:\n                self.setOutput(i, output)\n            else:\n                logger.warning(f\"Output {i} has no mimeType, skipping...\")\n                self.outputs[i][\"value\"] = str(output[i])\n\n    @staticmethod\n    def local_get_file(fileName):\n        \"\"\"Read and load the contents of a yaml file.\"\"\"\n        try:\n            with open(fileName) as file:\n                data = yaml.safe_load(file)\n            return data\n        except (FileNotFoundError, yaml.YAMLError, yaml.scanner.ScannerError):\n            return {}\n\n    def get_pod_env_vars(self) -&gt; dict[str, str]:\n        \"\"\"Get environment variables for the pod spawned by calrissian.\"\"\"\n        logger.info(\"get_pod_env_vars\")\n        return self.conf.get(\"pod_env_vars\", {})\n\n    def get_pod_node_selector(self) -&gt; dict[str, str]:\n        \"\"\"Get node selector for the pod spawned by calrissian.\"\"\"\n        logger.info(\"get_pod_node_selector\")\n        return self.conf.get(\"pod_node_selector\", {})\n\n    def get_additional_parameters(self) -&gt; dict[str, str]:\n        \"\"\"Get additional parameters for the execution.\"\"\"\n        logger.info(\"get_additional_parameters\")\n        additional_parameters = self.conf.get(\"additional_parameters\", {})\n        additional_parameters[\"sub_path\"] = self.conf[\"lenv\"][\"usid\"]\n        return additional_parameters\n\n    def get_secrets(self):\n        \"\"\"Get secrets for the pod spawned by calrissian.\"\"\"\n        logger.info(\"get_secrets\")\n        secrets = {\n            \"imagePullSecrets\": self.local_get_file(\"/assets/pod_imagePullSecrets.yaml\"),\n            \"additionalImagePullSecrets\": self.local_get_file(\n                \"/assets/pod_additionalImagePullSecrets.yaml\"\n            ),\n        }\n        return secrets\n\n    def handle_outputs(self, log, output, usage_report, tool_logs):\n        \"\"\"Handle the output files of the execution and register tool logs.\"\"\"\n        try:\n            logger.info(\"handle_outputs\")\n\n            # Update tmpUrl with user path\n            self.conf[\"main\"][\"tmpUrl\"] = self.conf[\"main\"][\"tmpUrl\"].replace(\n                \"temp/\", self.conf[\"auth_env\"][\"user\"] + \"/temp/\"\n            )\n\n            # Create service logs entries\n            services_logs = [\n                {\n                    \"url\": os.path.join(\n                        self.conf[\"main\"][\"tmpUrl\"],\n                        f\"{self.conf['lenv']['Identifier']}-{self.conf['lenv']['usid']}\",\n                        os.path.basename(tool_log),\n                    ),\n                    \"title\": f\"Tool log {os.path.basename(tool_log)}\",\n                    \"rel\": \"related\",\n                }\n                for tool_log in tool_logs\n            ]\n\n            cindex = 0\n            if \"service_logs\" in self.conf:\n                cindex = 1\n\n            for i in range(len(services_logs)):\n                okeys = [\"url\", \"title\", \"rel\"]\n                keys = [\"url\", \"title\", \"rel\"]\n                if cindex &gt; 0:\n                    for j in range(len(keys)):\n                        keys[j] = keys[j] + \"_\" + str(cindex)\n                if \"service_logs\" not in self.conf:\n                    self.conf[\"service_logs\"] = {}\n                for j in range(len(keys)):\n                    self.conf[\"service_logs\"][keys[j]] = services_logs[i][okeys[j]]\n                cindex += 1\n                logger.warning(f\"service_logs: {self.conf['service_logs']}\")\n\n            self.conf[\"service_logs\"][\"length\"] = str(cindex)\n            logger.info(f\"service_logs: {self.conf['service_logs']}\")\n\n        except Exception as e:\n            logger.error(\"ERROR in handle_outputs...\")\n            logger.error(traceback.format_exc())\n            raise (e)\n</code></pre>"},{"location":"api-reference/common-execution-handler/#zoo_template_common.common_execution_handler.CommonExecutionHandler.get_additional_parameters","title":"<code>get_additional_parameters()</code>","text":"<p>Get additional parameters for the execution.</p> Source code in <code>zoo_template_common/common_execution_handler.py</code> <pre><code>def get_additional_parameters(self) -&gt; dict[str, str]:\n    \"\"\"Get additional parameters for the execution.\"\"\"\n    logger.info(\"get_additional_parameters\")\n    additional_parameters = self.conf.get(\"additional_parameters\", {})\n    additional_parameters[\"sub_path\"] = self.conf[\"lenv\"][\"usid\"]\n    return additional_parameters\n</code></pre>"},{"location":"api-reference/common-execution-handler/#zoo_template_common.common_execution_handler.CommonExecutionHandler.get_pod_env_vars","title":"<code>get_pod_env_vars()</code>","text":"<p>Get environment variables for the pod spawned by calrissian.</p> Source code in <code>zoo_template_common/common_execution_handler.py</code> <pre><code>def get_pod_env_vars(self) -&gt; dict[str, str]:\n    \"\"\"Get environment variables for the pod spawned by calrissian.\"\"\"\n    logger.info(\"get_pod_env_vars\")\n    return self.conf.get(\"pod_env_vars\", {})\n</code></pre>"},{"location":"api-reference/common-execution-handler/#zoo_template_common.common_execution_handler.CommonExecutionHandler.get_pod_node_selector","title":"<code>get_pod_node_selector()</code>","text":"<p>Get node selector for the pod spawned by calrissian.</p> Source code in <code>zoo_template_common/common_execution_handler.py</code> <pre><code>def get_pod_node_selector(self) -&gt; dict[str, str]:\n    \"\"\"Get node selector for the pod spawned by calrissian.\"\"\"\n    logger.info(\"get_pod_node_selector\")\n    return self.conf.get(\"pod_node_selector\", {})\n</code></pre>"},{"location":"api-reference/common-execution-handler/#zoo_template_common.common_execution_handler.CommonExecutionHandler.get_secrets","title":"<code>get_secrets()</code>","text":"<p>Get secrets for the pod spawned by calrissian.</p> Source code in <code>zoo_template_common/common_execution_handler.py</code> <pre><code>def get_secrets(self):\n    \"\"\"Get secrets for the pod spawned by calrissian.\"\"\"\n    logger.info(\"get_secrets\")\n    secrets = {\n        \"imagePullSecrets\": self.local_get_file(\"/assets/pod_imagePullSecrets.yaml\"),\n        \"additionalImagePullSecrets\": self.local_get_file(\n            \"/assets/pod_additionalImagePullSecrets.yaml\"\n        ),\n    }\n    return secrets\n</code></pre>"},{"location":"api-reference/common-execution-handler/#zoo_template_common.common_execution_handler.CommonExecutionHandler.handle_outputs","title":"<code>handle_outputs(log, output, usage_report, tool_logs)</code>","text":"<p>Handle the output files of the execution and register tool logs.</p> Source code in <code>zoo_template_common/common_execution_handler.py</code> <pre><code>def handle_outputs(self, log, output, usage_report, tool_logs):\n    \"\"\"Handle the output files of the execution and register tool logs.\"\"\"\n    try:\n        logger.info(\"handle_outputs\")\n\n        # Update tmpUrl with user path\n        self.conf[\"main\"][\"tmpUrl\"] = self.conf[\"main\"][\"tmpUrl\"].replace(\n            \"temp/\", self.conf[\"auth_env\"][\"user\"] + \"/temp/\"\n        )\n\n        # Create service logs entries\n        services_logs = [\n            {\n                \"url\": os.path.join(\n                    self.conf[\"main\"][\"tmpUrl\"],\n                    f\"{self.conf['lenv']['Identifier']}-{self.conf['lenv']['usid']}\",\n                    os.path.basename(tool_log),\n                ),\n                \"title\": f\"Tool log {os.path.basename(tool_log)}\",\n                \"rel\": \"related\",\n            }\n            for tool_log in tool_logs\n        ]\n\n        cindex = 0\n        if \"service_logs\" in self.conf:\n            cindex = 1\n\n        for i in range(len(services_logs)):\n            okeys = [\"url\", \"title\", \"rel\"]\n            keys = [\"url\", \"title\", \"rel\"]\n            if cindex &gt; 0:\n                for j in range(len(keys)):\n                    keys[j] = keys[j] + \"_\" + str(cindex)\n            if \"service_logs\" not in self.conf:\n                self.conf[\"service_logs\"] = {}\n            for j in range(len(keys)):\n                self.conf[\"service_logs\"][keys[j]] = services_logs[i][okeys[j]]\n            cindex += 1\n            logger.warning(f\"service_logs: {self.conf['service_logs']}\")\n\n        self.conf[\"service_logs\"][\"length\"] = str(cindex)\n        logger.info(f\"service_logs: {self.conf['service_logs']}\")\n\n    except Exception as e:\n        logger.error(\"ERROR in handle_outputs...\")\n        logger.error(traceback.format_exc())\n        raise (e)\n</code></pre>"},{"location":"api-reference/common-execution-handler/#zoo_template_common.common_execution_handler.CommonExecutionHandler.local_get_file","title":"<code>local_get_file(fileName)</code>  <code>staticmethod</code>","text":"<p>Read and load the contents of a yaml file.</p> Source code in <code>zoo_template_common/common_execution_handler.py</code> <pre><code>@staticmethod\ndef local_get_file(fileName):\n    \"\"\"Read and load the contents of a yaml file.\"\"\"\n    try:\n        with open(fileName) as file:\n            data = yaml.safe_load(file)\n        return data\n    except (FileNotFoundError, yaml.YAMLError, yaml.scanner.ScannerError):\n        return {}\n</code></pre>"},{"location":"api-reference/common-execution-handler/#zoo_template_common.common_execution_handler.CommonExecutionHandler.post_execution_hook","title":"<code>post_execution_hook(log, output, usage_report, tool_logs)</code>","text":"<p>Hook to run after execution. Sets up S3 environment and processes outputs.</p> Source code in <code>zoo_template_common/common_execution_handler.py</code> <pre><code>def post_execution_hook(self, log, output, usage_report, tool_logs):\n    \"\"\"Hook to run after execution. Sets up S3 environment and processes outputs.\"\"\"\n    # Unset HTTP proxy or else the S3 client will use it and fail\n    os.environ.pop(\"HTTP_PROXY\", None)\n\n    # Set S3 environment variables from additional parameters\n    additional_params = self.get_additional_parameters()\n    os.environ[\"AWS_S3_REGION\"] = additional_params.get(\"region_name\", \"\")\n    os.environ[\"AWS_S3_ENDPOINT\"] = additional_params.get(\"endpoint_url\", \"\")\n    os.environ[\"AWS_ACCESS_KEY_ID\"] = additional_params.get(\"aws_access_key_id\", \"\")\n    os.environ[\"AWS_SECRET_ACCESS_KEY\"] = additional_params.get(\"aws_secret_access_key\", \"\")\n\n    logger.info(\"Post execution hook\")\n\n    from zoo_template_common.custom_stac_io import CustomStacIO\n\n    StacIO.set_default(CustomStacIO)\n\n    for i in self.outputs:\n        logger.info(f\"Output {i}: {self.outputs[i]}\")\n        if \"mimeType\" in self.outputs[i]:\n            self.setOutput(i, output)\n        else:\n            logger.warning(f\"Output {i} has no mimeType, skipping...\")\n            self.outputs[i][\"value\"] = str(output[i])\n</code></pre>"},{"location":"api-reference/common-execution-handler/#zoo_template_common.common_execution_handler.CommonExecutionHandler.pre_execution_hook","title":"<code>pre_execution_hook()</code>","text":"<p>Hook to run before execution. Override in subclasses for custom behavior.</p> Source code in <code>zoo_template_common/common_execution_handler.py</code> <pre><code>def pre_execution_hook(self):\n    \"\"\"Hook to run before execution. Override in subclasses for custom behavior.\"\"\"\n    logger.info(\"Pre execution hook\")\n</code></pre>"},{"location":"api-reference/common-execution-handler/#zoo_template_common.common_execution_handler.CommonExecutionHandler.setOutput","title":"<code>setOutput(outputName, values)</code>","text":"<p>Process and set output values from STAC catalog.</p> Source code in <code>zoo_template_common/common_execution_handler.py</code> <pre><code>def setOutput(self, outputName, values):\n    \"\"\"Process and set output values from STAC catalog.\"\"\"\n    output = self.outputs[outputName]\n    logger.info(f\"Read catalog from STAC Catalog URI: {output} -&gt; {values}\")\n\n    if not isinstance(values[outputName], list):\n        logger.info(f\"values[{outputName}] is not a list, transform to an array\")\n        values[outputName] = [values[outputName]]\n\n    items = []\n\n    for i in range(len(values[outputName])):\n        if values[outputName][i] is None:\n            break\n        cat: Catalog = read_file(values[outputName][i][\"value\"])\n\n        collection_id = self.get_additional_parameters()[\"sub_path\"]\n        logger.info(f\"Create collection with ID {collection_id}\")\n\n        collection = None\n\n        try:\n            logger.info(f\"Catalog : {dir(cat)}\")\n            collection: Collection = next(cat.get_all_collections())\n        except Exception:\n            logger.error(\"No collection found in the output catalog\")\n            output[\"collection\"] = json.dumps({}, indent=2)\n            return\n\n        logger.info(f\"Got collection {collection.id} from processing outputs\")\n\n        for item in collection.get_all_items():\n            logger.info(f\"Processing item {item.id}\")\n\n            for asset_key in item.assets.keys():\n                logger.info(f\"Processing asset {asset_key}\")\n\n                temp_asset = item.assets[asset_key].to_dict()\n                temp_asset[\"storage:platform\"] = self.get_additional_parameters().get(\n                    \"storage_platform\", \"default\"\n                )\n                temp_asset[\"storage:requester_pays\"] = False\n                temp_asset[\"storage:tier\"] = \"Standard\"\n                temp_asset[\"storage:region\"] = self.get_additional_parameters().get(\n                    \"region_name\", \"default\"\n                )\n                temp_asset[\"storage:endpoint\"] = self.get_additional_parameters().get(\n                    \"endpoint_url\", \"\"\n                )\n                item.assets[asset_key] = item.assets[asset_key].from_dict(temp_asset)\n\n            item.collection_id = collection_id\n            items.append(item.clone())\n\n    item_collection = ItemCollection(items=items)\n    logger.info(\"Created feature collection from items\")\n\n    # Trap the case of no output collection\n    if item_collection is None:\n        logger.error(\"The output collection is empty\")\n        output[\"collection\"] = json.dumps({}, indent=2)\n        return\n\n    # Set the feature collection to be returned\n    output[\"collection\"] = item_collection.to_dict()\n    output[\"collection\"][\"id\"] = collection_id\n</code></pre>"},{"location":"api-reference/common-execution-handler/#class-overview","title":"Class Overview","text":"<p><code>CommonExecutionHandler</code> is the base class for all CWL workflow execution handlers in ZOO-Project services.</p>"},{"location":"api-reference/common-execution-handler/#constructor","title":"Constructor","text":"<pre><code>def __init__(self, conf, outputs=None)\n</code></pre> <p>Parameters:</p> <ul> <li><code>conf</code> (dict): ZOO configuration dictionary containing service configuration and environment</li> <li><code>outputs</code> (dict, optional): ZOO outputs dictionary for storing results</li> </ul> <p>Example:</p> <pre><code>handler = CommonExecutionHandler(conf, outputs)\n</code></pre>"},{"location":"api-reference/common-execution-handler/#methods","title":"Methods","text":""},{"location":"api-reference/common-execution-handler/#pre_execution_hook","title":"pre_execution_hook()","text":"<p>Called before workflow execution. Override to perform setup tasks.</p> <pre><code>def pre_execution_hook(self):\n    \"\"\"Hook called before execution\"\"\"\n    pass\n</code></pre> <p>Use cases: - Load configuration - Validate inputs - Setup environment variables - Initialize connections</p> <p>Example:</p> <pre><code>def pre_execution_hook(self):\n    secrets = self.get_secrets()\n    os.environ[\"API_KEY\"] = secrets.get(\"api_key\")\n</code></pre>"},{"location":"api-reference/common-execution-handler/#post_execution_hook","title":"post_execution_hook()","text":"<p>Called after workflow execution. Override to process results.</p> <pre><code>def post_execution_hook(self, log, output, usage_report, tool_logs):\n    \"\"\"Hook called after execution\"\"\"\n    # Setup S3 environment\n    os.environ[\"S3_ENDPOINT\"] = self.conf.get(\"eoepca\", {}).get(\"S3\", {}).get(\"url\", \"\")\n</code></pre> <p>Parameters:</p> <ul> <li><code>log</code>: Execution log</li> <li><code>output</code>: Workflow output data</li> <li><code>usage_report</code>: Resource usage statistics</li> <li><code>tool_logs</code>: Tool-specific logs</li> </ul> <p>Use cases: - Process workflow outputs - Save results - Send notifications - Cleanup resources</p> <p>Example:</p> <pre><code>def post_execution_hook(self, log, output, usage_report, tool_logs):\n    super().post_execution_hook(log, output, usage_report, tool_logs)\n    self.save_results(output)\n    self.send_notification(\"completed\")\n</code></pre>"},{"location":"api-reference/common-execution-handler/#setoutput","title":"setOutput()","text":"<p>Process and set output values, handles STAC catalog processing.</p> <pre><code>def setOutput(self, outputName, values)\n</code></pre> <p>Parameters:</p> <ul> <li><code>outputName</code> (str): Name of the output</li> <li><code>values</code> (dict): Output values containing STAC catalog or data</li> </ul> <p>Behavior:</p> <ul> <li>If <code>values</code> contains <code>\"stac\"</code> key, processes as STAC catalog</li> <li>Reads STAC catalog file</li> <li>Converts ItemCollections to Catalogs</li> <li>Updates output dictionary</li> </ul> <p>Example:</p> <pre><code>handler.setOutput(\"result\", {\n    \"stac\": \"/tmp/catalog.json\",\n    \"type\": \"application/json\"\n})\n</code></pre>"},{"location":"api-reference/common-execution-handler/#get_pod_env_vars","title":"get_pod_env_vars()","text":"<p>Get environment variables for pod/container execution.</p> <pre><code>def get_pod_env_vars(self) -&gt; dict\n</code></pre> <p>Returns: - dict: Environment variables to set in execution pod</p> <p>Default: - Empty dictionary</p> <p>Example:</p> <pre><code>def get_pod_env_vars(self):\n    env_vars = super().get_pod_env_vars()\n    env_vars[\"CUSTOM_VAR\"] = \"value\"\n    env_vars[\"LOG_LEVEL\"] = \"DEBUG\"\n    return env_vars\n</code></pre>"},{"location":"api-reference/common-execution-handler/#get_pod_node_selector","title":"get_pod_node_selector()","text":"<p>Get node selector for pod scheduling.</p> <pre><code>def get_pod_node_selector(self) -&gt; dict\n</code></pre> <p>Returns: - dict: Node selector labels for Kubernetes scheduling</p> <p>Default: - Empty dictionary</p> <p>Example:</p> <pre><code>def get_pod_node_selector(self):\n    return {\n        \"workload\": \"processing\",\n        \"gpu\": \"true\"\n    }\n</code></pre>"},{"location":"api-reference/common-execution-handler/#get_additional_parameters","title":"get_additional_parameters()","text":"<p>Get additional parameters for workflow execution.</p> <pre><code>def get_additional_parameters(self) -&gt; dict\n</code></pre> <p>Returns: - dict: Additional parameters for the workflow</p> <p>Default: - Empty dictionary</p> <p>Example:</p> <pre><code>def get_additional_parameters(self):\n    return {\n        \"max_cores\": 8,\n        \"max_ram\": \"16G\",\n        \"timeout\": 3600\n    }\n</code></pre>"},{"location":"api-reference/common-execution-handler/#get_secrets","title":"get_secrets()","text":"<p>Load secrets from YAML configuration files.</p> <pre><code>def get_secrets(self) -&gt; dict\n</code></pre> <p>Returns: - dict: Secrets loaded from configuration files</p> <p>Searched paths: 1. <code>/var/etc/secrets/processing_secrets.yaml</code> 2. <code>/var/etc/zoo-services-user/processing_secrets.yaml</code></p> <p>Example:</p> <pre><code>secrets = handler.get_secrets()\napi_key = secrets.get(\"api_key\")\ndb_password = secrets.get(\"db_password\")\n</code></pre>"},{"location":"api-reference/common-execution-handler/#handle_outputs","title":"handle_outputs()","text":"<p>Register tool logs as workflow outputs.</p> <pre><code>def handle_outputs(self, log, output, usage_report, tool_logs)\n</code></pre> <p>Parameters:</p> <ul> <li><code>log</code>: Execution log</li> <li><code>output</code>: Workflow outputs</li> <li><code>usage_report</code>: Resource usage</li> <li><code>tool_logs</code>: Tool execution logs</li> </ul> <p>Example:</p> <pre><code>handler.handle_outputs(log, output, usage_report, tool_logs)\n</code></pre>"},{"location":"api-reference/common-execution-handler/#local_get_file","title":"local_get_file()","text":"<p>Static method to load YAML file.</p> <pre><code>@staticmethod\ndef local_get_file(fileName: str) -&gt; dict\n</code></pre> <p>Parameters:</p> <ul> <li><code>fileName</code> (str): Path to YAML file</li> </ul> <p>Returns: - dict: Parsed YAML content</p> <p>Example:</p> <pre><code>config = CommonExecutionHandler.local_get_file(\"/path/to/config.yaml\")\n</code></pre>"},{"location":"api-reference/common-execution-handler/#attributes","title":"Attributes","text":""},{"location":"api-reference/common-execution-handler/#conf","title":"conf","text":"<p>ZOO configuration dictionary.</p> <pre><code>handler.conf  # dict\n</code></pre> <p>Structure: <pre><code>{\n    \"lenv\": {\n        \"message\": \"\",  # Error/status messages\n        \"Identifier\": \"service-id\"\n    },\n    \"main\": {\n        \"tmpPath\": \"/tmp\"\n    },\n    \"inputs\": {...},  # Service inputs\n    \"eoepca\": {  # EOEPCA configuration\n        \"S3\": {\n            \"url\": \"https://s3.example.com\"\n        }\n    }\n}\n</code></pre></p>"},{"location":"api-reference/common-execution-handler/#outputs","title":"outputs","text":"<p>ZOO outputs dictionary.</p> <pre><code>handler.outputs  # dict or None\n</code></pre> <p>Structure: <pre><code>{\n    \"result\": {\n        \"value\": \"...\",\n        \"mimeType\": \"application/json\"\n    }\n}\n</code></pre></p>"},{"location":"api-reference/common-execution-handler/#usage-pattern","title":"Usage Pattern","text":"<p>Typical usage pattern:</p> <pre><code>class MyHandler(CommonExecutionHandler):\n    def pre_execution_hook(self):\n        # Setup\n        super().pre_execution_hook()\n        self.setup_environment()\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        # Process results\n        super().post_execution_hook(log, output, usage_report, tool_logs)\n        self.process_results(output)\n\n    def get_pod_env_vars(self):\n        env = super().get_pod_env_vars()\n        env[\"CUSTOM\"] = \"value\"\n        return env\n\n# Use in ZOO service\ndef my_service(conf, inputs, outputs):\n    handler = MyHandler(conf, outputs)\n    handler.pre_execution_hook()\n    # Execute workflow...\n    handler.post_execution_hook(None, outputs, None, None)\n    return 3  # SUCCESS\n</code></pre>"},{"location":"api-reference/common-execution-handler/#see-also","title":"See Also","text":"<ul> <li>CustomStacIO - STAC I/O customization</li> <li>Basic Usage - Usage examples</li> <li>Extending - Extension patterns</li> </ul>"},{"location":"api-reference/custom-stac-io/","title":"CustomStacIO API Reference","text":""},{"location":"api-reference/custom-stac-io/#zoo_template_common.custom_stac_io.CustomStacIO","title":"<code>CustomStacIO</code>","text":"<p>               Bases: <code>DefaultStacIO</code></p> <p>Custom STAC IO class that uses boto3 to read/write from S3.</p> Source code in <code>zoo_template_common/custom_stac_io.py</code> <pre><code>class CustomStacIO(DefaultStacIO):\n    \"\"\"Custom STAC IO class that uses boto3 to read/write from S3.\"\"\"\n\n    def __init__(self):\n        self.session = botocore.session.Session()\n        self.s3_client = self.session.create_client(\n            service_name=\"s3\",\n            region_name=os.environ.get(\"AWS_REGION\"),\n            endpoint_url=os.environ.get(\"AWS_S3_ENDPOINT\"),\n            aws_access_key_id=os.environ.get(\"AWS_ACCESS_KEY_ID\"),\n            aws_secret_access_key=os.environ.get(\"AWS_SECRET_ACCESS_KEY\"),\n            verify=True,\n            use_ssl=True,\n            config=Config(s3={\"addressing_style\": \"path\", \"signature_version\": \"s3v4\"}),\n        )\n\n    def read_text(self, source, *args, **kwargs):\n        parsed = urlparse(source)\n        if parsed.scheme == \"s3\":\n            return (\n                self.s3_client.get_object(Bucket=parsed.netloc, Key=parsed.path[1:])[\"Body\"]\n                .read()\n                .decode(\"utf-8\")\n            )\n        else:\n            return super().read_text(source, *args, **kwargs)\n\n    def write_text(self, dest, txt, *args, **kwargs):\n        parsed = urlparse(dest)\n        if parsed.scheme == \"s3\":\n            self.s3_client.put_object(\n                Body=txt.encode(\"UTF-8\"),\n                Bucket=parsed.netloc,\n                Key=parsed.path[1:],\n                ContentType=\"application/geo+json\",\n            )\n        else:\n            super().write_text(dest, txt, *args, **kwargs)\n</code></pre>"},{"location":"api-reference/custom-stac-io/#class-overview","title":"Class Overview","text":"<p><code>CustomStacIO</code> is a custom STAC I/O implementation that handles reading STAC items from S3 storage using boto3.</p> <p>Extends <code>pystac.StacIO</code> to provide custom read/write operations for STAC catalogs stored in S3.</p>"},{"location":"api-reference/custom-stac-io/#constructor","title":"Constructor","text":"<pre><code>def __init__(self)\n</code></pre> <p>Creates a new CustomStacIO instance with boto3 S3 client configured from environment variables.</p> <p>Environment Variables:</p> <ul> <li><code>AWS_ACCESS_KEY_ID</code>: S3 access key</li> <li><code>AWS_SECRET_ACCESS_KEY</code>: S3 secret key  </li> <li><code>AWS_S3_ENDPOINT</code>: S3 endpoint URL</li> <li><code>AWS_DEFAULT_REGION</code>: AWS region (default: \"us-east-1\")</li> </ul> <p>Example:</p> <pre><code>from zoo_template_common import CustomStacIO\n\n# Configure S3 environment\nos.environ[\"AWS_ACCESS_KEY_ID\"] = \"...\"\nos.environ[\"AWS_SECRET_ACCESS_KEY\"] = \"...\"\nos.environ[\"AWS_S3_ENDPOINT\"] = \"https://s3.example.com\"\n\n# Create custom I/O\nstac_io = CustomStacIO()\n</code></pre>"},{"location":"api-reference/custom-stac-io/#methods","title":"Methods","text":""},{"location":"api-reference/custom-stac-io/#read_text","title":"read_text()","text":"<p>Read text content from a file or S3 object.</p> <pre><code>def read_text(self, source: str, *args, **kwargs) -&gt; str\n</code></pre> <p>Parameters:</p> <ul> <li><code>source</code> (str): File path or S3 URL (s3://bucket/key)</li> <li><code>*args</code>: Additional positional arguments</li> <li><code>**kwargs</code>: Additional keyword arguments</li> </ul> <p>Returns: - str: Text content from file or S3 object</p> <p>Behavior:</p> <ul> <li>If <code>source</code> starts with \"s3://\", reads from S3 using boto3</li> <li>Otherwise, reads from local filesystem</li> <li>Parses S3 URL to extract bucket and key</li> <li>Returns decoded UTF-8 text</li> </ul> <p>Example:</p> <pre><code># Read from S3\ncontent = stac_io.read_text(\"s3://my-bucket/catalog.json\")\n\n# Read from local file\ncontent = stac_io.read_text(\"/tmp/catalog.json\")\n</code></pre>"},{"location":"api-reference/custom-stac-io/#write_text","title":"write_text()","text":"<p>Write text content to a file.</p> <pre><code>def write_text(self, dest: str, txt: str, *args, **kwargs) -&gt; None\n</code></pre> <p>Parameters:</p> <ul> <li><code>dest</code> (str): Destination file path</li> <li><code>txt</code> (str): Text content to write</li> <li><code>*args</code>: Additional positional arguments</li> <li><code>**kwargs</code>: Additional keyword arguments</li> </ul> <p>Behavior:</p> <ul> <li>Creates parent directories if they don't exist</li> <li>Writes text to file using UTF-8 encoding</li> </ul> <p>Example:</p> <pre><code>import json\n\ncatalog_data = {\"type\": \"Catalog\", \"id\": \"my-catalog\"}\nstac_io.write_text(\"/tmp/catalog.json\", json.dumps(catalog_data))\n</code></pre>"},{"location":"api-reference/custom-stac-io/#read_json","title":"read_json()","text":"<p>Read and parse JSON from file or S3.</p> <pre><code>def read_json(self, source: str, *args, **kwargs) -&gt; dict\n</code></pre> <p>Parameters:</p> <ul> <li><code>source</code> (str): File path or S3 URL</li> </ul> <p>Returns: - dict: Parsed JSON data</p> <p>Example:</p> <pre><code>catalog = stac_io.read_json(\"s3://bucket/catalog.json\")\nprint(catalog[\"type\"])  # \"Catalog\"\n</code></pre>"},{"location":"api-reference/custom-stac-io/#usage-with-pystac","title":"Usage with PySTAC","text":""},{"location":"api-reference/custom-stac-io/#set-as-default-stac-io","title":"Set as Default STAC I/O","text":"<pre><code>from pystac import set_stac_io\nfrom zoo_template_common import CustomStacIO\n\n# Set as default for all PySTAC operations\nset_stac_io(CustomStacIO())\n\n# Now all PySTAC operations use CustomStacIO\nfrom pystac import Catalog\ncatalog = Catalog.from_file(\"s3://bucket/catalog.json\")\n</code></pre>"},{"location":"api-reference/custom-stac-io/#read-stac-catalog-from-s3","title":"Read STAC Catalog from S3","text":"<pre><code>from pystac import Catalog\nfrom zoo_template_common import CustomStacIO\nimport os\n\n# Configure S3\nos.environ[\"AWS_ACCESS_KEY_ID\"] = \"your-key\"\nos.environ[\"AWS_SECRET_ACCESS_KEY\"] = \"your-secret\"\nos.environ[\"AWS_S3_ENDPOINT\"] = \"https://s3.example.com\"\n\n# Set custom I/O\nfrom pystac import set_stac_io\nset_stac_io(CustomStacIO())\n\n# Read catalog from S3\ncatalog = Catalog.from_file(\"s3://my-bucket/results/catalog.json\")\n\n# Iterate items\nfor item in catalog.get_items():\n    print(f\"Item: {item.id}\")\n    print(f\"Assets: {list(item.assets.keys())}\")\n</code></pre>"},{"location":"api-reference/custom-stac-io/#write-stac-catalog","title":"Write STAC Catalog","text":"<pre><code>from pystac import Catalog, Item\nfrom zoo_template_common import CustomStacIO\nfrom pystac import set_stac_io\n\nset_stac_io(CustomStacIO())\n\n# Create catalog\ncatalog = Catalog(\n    id=\"my-catalog\",\n    description=\"Processing results\"\n)\n\n# Add items\nitem = Item(\n    id=\"result-1\",\n    geometry=None,\n    bbox=None,\n    datetime=datetime.utcnow(),\n    properties={}\n)\ncatalog.add_item(item)\n\n# Save to local filesystem\ncatalog.normalize_and_save(\"/tmp/output/catalog.json\")\n</code></pre>"},{"location":"api-reference/custom-stac-io/#s3-url-format","title":"S3 URL Format","text":"<p>CustomStacIO supports S3 URLs in the format:</p> <pre><code>s3://bucket-name/path/to/object\n</code></pre> <p>Parsing:</p> <ul> <li>Scheme: <code>s3://</code></li> <li>Bucket: <code>bucket-name</code></li> <li>Key: <code>path/to/object</code></li> </ul> <p>Example URLs:</p> <pre><code># Valid S3 URLs\n\"s3://my-bucket/catalog.json\"\n\"s3://results/2024/01/15/output/catalog.json\"\n\"s3://eoepca-data/workflows/job-123/results/catalog.json\"\n</code></pre>"},{"location":"api-reference/custom-stac-io/#error-handling","title":"Error Handling","text":"<pre><code>from botocore.exceptions import ClientError\n\ntry:\n    content = stac_io.read_text(\"s3://bucket/catalog.json\")\nexcept ClientError as e:\n    if e.response['Error']['Code'] == 'NoSuchKey':\n        print(\"Object not found\")\n    elif e.response['Error']['Code'] == 'NoSuchBucket':\n        print(\"Bucket not found\")\n    else:\n        print(f\"S3 error: {e}\")\nexcept Exception as e:\n    print(f\"Error: {e}\")\n</code></pre>"},{"location":"api-reference/custom-stac-io/#configuration","title":"Configuration","text":""},{"location":"api-reference/custom-stac-io/#environment-variables","title":"Environment Variables","text":"<p>Required for S3 access:</p> <pre><code>export AWS_ACCESS_KEY_ID=\"your-access-key\"\nexport AWS_SECRET_ACCESS_KEY=\"your-secret-key\"\nexport AWS_S3_ENDPOINT=\"https://s3.example.com\"\nexport AWS_DEFAULT_REGION=\"us-east-1\"\n</code></pre>"},{"location":"api-reference/custom-stac-io/#boto3-session","title":"Boto3 Session","text":"<p>CustomStacIO creates a boto3 session with:</p> <pre><code>session = boto3.Session(\n    aws_access_key_id=os.environ.get(\"AWS_ACCESS_KEY_ID\"),\n    aws_secret_access_key=os.environ.get(\"AWS_SECRET_ACCESS_KEY\"),\n    region_name=os.environ.get(\"AWS_DEFAULT_REGION\", \"us-east-1\")\n)\n</code></pre>"},{"location":"api-reference/custom-stac-io/#complete-example","title":"Complete Example","text":"<pre><code>from zoo_template_common import CustomStacIO, CommonExecutionHandler\nfrom pystac import set_stac_io, Catalog\nimport os\n\nclass MyHandler(CommonExecutionHandler):\n    def pre_execution_hook(self):\n        \"\"\"Setup STAC I/O\"\"\"\n        # Configure S3\n        secrets = self.get_secrets()\n        os.environ[\"AWS_ACCESS_KEY_ID\"] = secrets[\"s3_key\"]\n        os.environ[\"AWS_SECRET_ACCESS_KEY\"] = secrets[\"s3_secret\"]\n        os.environ[\"AWS_S3_ENDPOINT\"] = \"https://s3.example.com\"\n\n        # Set custom STAC I/O\n        set_stac_io(CustomStacIO())\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Process STAC catalog from S3\"\"\"\n        super().post_execution_hook(log, output, usage_report, tool_logs)\n\n        # Read catalog from S3\n        catalog_url = output.get(\"stac\")\n        if catalog_url and catalog_url.startswith(\"s3://\"):\n            catalog = Catalog.from_file(catalog_url)\n\n            # Process items\n            for item in catalog.get_items():\n                print(f\"Processing item: {item.id}\")\n</code></pre>"},{"location":"api-reference/custom-stac-io/#see-also","title":"See Also","text":"<ul> <li>CommonExecutionHandler - Main handler class</li> <li>Basic Usage - Usage examples</li> <li>PySTAC Documentation - PySTAC library</li> </ul>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#requirements","title":"Requirements","text":"<ul> <li>Python &gt;= 3.8</li> <li>pip or poetry</li> </ul>"},{"location":"getting-started/installation/#install-from-pypi","title":"Install from PyPI","text":"<pre><code>pip install zoo-template-common\n</code></pre>"},{"location":"getting-started/installation/#install-from-git","title":"Install from Git","text":""},{"location":"getting-started/installation/#latest-release","title":"Latest release","text":"<pre><code>pip install git+https://github.com/ZOO-Project/zoo-template-common.git@main\n</code></pre>"},{"location":"getting-started/installation/#specific-branch","title":"Specific branch","text":"<pre><code>pip install git+https://github.com/ZOO-Project/zoo-template-common.git@feature/pythoupdates\n</code></pre>"},{"location":"getting-started/installation/#development-installation","title":"Development Installation","text":"<p>For development, clone the repository and install in editable mode:</p> <pre><code>git clone https://github.com/ZOO-Project/zoo-template-common.git\ncd zoo-template-common\npip install -e .\n</code></pre>"},{"location":"getting-started/installation/#dependencies","title":"Dependencies","text":"<p>The package automatically installs the following dependencies:</p> <ul> <li>loguru &gt;= 0.7.0</li> <li>pystac &gt;= 1.8.0</li> <li>pyyaml &gt;= 6.0</li> <li>boto3 &gt;= 1.28.0</li> <li>botocore &gt;= 1.31.0</li> </ul>"},{"location":"getting-started/installation/#verify-installation","title":"Verify Installation","text":"<pre><code>python -c \"from zoo_template_common import CommonExecutionHandler; print('Installation successful')\"\n</code></pre>"},{"location":"getting-started/quickstart/","title":"Quick Start","text":"<p>This guide will help you get started with zoo-template-common.</p>"},{"location":"getting-started/quickstart/#basic-usage","title":"Basic Usage","text":""},{"location":"getting-started/quickstart/#1-import-the-handler","title":"1. Import the Handler","text":"<pre><code>from zoo_template_common import CommonExecutionHandler\nfrom zoo_calrissian_runner import ZooCalrissianRunner\nimport yaml\n</code></pre>"},{"location":"getting-started/quickstart/#2-create-an-execution-handler","title":"2. Create an Execution Handler","text":"<pre><code>def my_workflow(conf, inputs, outputs):\n    # Create the execution handler\n    execution_handler = CommonExecutionHandler(conf=conf, outputs=outputs)\n\n    # Load CWL workflow\n    with open(\"app-package.cwl\", \"r\") as f:\n        cwl = yaml.safe_load(f)\n\n    # Create the runner\n    runner = ZooCalrissianRunner(\n        cwl=cwl,\n        conf=conf,\n        inputs=inputs,\n        outputs=outputs,\n        execution_handler=execution_handler,\n    )\n\n    # Execute\n    exit_status = runner.execute()\n\n    return exit_status\n</code></pre>"},{"location":"getting-started/quickstart/#3-process-outputs","title":"3. Process Outputs","text":"<p>The handler automatically processes STAC catalog outputs and sets up the environment for S3 operations.</p>"},{"location":"getting-started/quickstart/#extending-the-handler","title":"Extending the Handler","text":"<p>For custom behavior, extend <code>CommonExecutionHandler</code>:</p> <pre><code>from zoo_template_common import CommonExecutionHandler\n\nclass MyCustomHandler(CommonExecutionHandler):\n    def pre_execution_hook(self):\n        \"\"\"Custom logic before execution\"\"\"\n        super().pre_execution_hook()\n        # Your custom code here\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Custom logic after execution\"\"\"\n        # Your custom code here\n        super().post_execution_hook(log, output, usage_report, tool_logs)\n</code></pre>"},{"location":"getting-started/quickstart/#configuration","title":"Configuration","text":"<p>The handler expects a configuration dictionary:</p> <pre><code>conf = {\n    \"lenv\": {\n        \"usid\": \"unique-execution-id\",\n        \"Identifier\": \"workflow-name\"\n    },\n    \"main\": {\n        \"tmpPath\": \"/tmp/zoo\",\n        \"tmpUrl\": \"http://example.com/temp/\"\n    },\n    \"auth_env\": {\n        \"user\": \"username\"\n    },\n    \"additional_parameters\": {\n        \"region_name\": \"us-east-1\",\n        \"endpoint_url\": \"https://s3.amazonaws.com\",\n        \"aws_access_key_id\": \"ACCESS_KEY\",\n        \"aws_secret_access_key\": \"SECRET_KEY\"\n    }\n}\n</code></pre>"},{"location":"getting-started/quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>Learn more about Basic Usage</li> <li>Learn about Extending the Handler</li> <li>Explore Complete Examples</li> <li>Read the API Reference</li> </ul>"},{"location":"user-guide/basic-usage/","title":"Basic Usage","text":"<p>This guide covers the basic usage of <code>zoo-template-common</code> in your ZOO services.</p>"},{"location":"user-guide/basic-usage/#simple-handler","title":"Simple Handler","text":"<p>The most basic usage extends <code>CommonExecutionHandler</code>:</p> <pre><code>from zoo_template_common import CommonExecutionHandler\n\nclass MyExecutionHandler(CommonExecutionHandler):\n    \"\"\"Custom execution handler\"\"\"\n\n    def __init__(self, conf, outputs=None):\n        super().__init__(conf, outputs)\n</code></pre>"},{"location":"user-guide/basic-usage/#pre-execution-hook","title":"Pre-Execution Hook","text":"<p>Override <code>pre_execution_hook()</code> to perform setup before workflow execution:</p> <pre><code>class MyExecutionHandler(CommonExecutionHandler):\n    def pre_execution_hook(self):\n        \"\"\"Setup before execution\"\"\"\n        # Load configuration\n        self.config = self.load_config()\n\n        # Validate inputs\n        if not self.validate_inputs():\n            raise ValueError(\"Invalid inputs\")\n\n        # Setup environment\n        os.environ[\"CUSTOM_VAR\"] = \"value\"\n</code></pre>"},{"location":"user-guide/basic-usage/#post-execution-hook","title":"Post-Execution Hook","text":"<p>Override <code>post_execution_hook()</code> to process results after workflow execution:</p> <pre><code>class MyExecutionHandler(CommonExecutionHandler):\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Process results after execution\"\"\"\n        # Call parent to setup S3 environment\n        super().post_execution_hook(log, output, usage_report, tool_logs)\n\n        # Custom processing\n        self.process_outputs(output)\n        self.send_notification()\n</code></pre>"},{"location":"user-guide/basic-usage/#output-processing","title":"Output Processing","text":"<p>Use <code>setOutput()</code> to process STAC catalogs:</p> <pre><code>class MyExecutionHandler(CommonExecutionHandler):\n    def process_results(self, results_path):\n        \"\"\"Process workflow results\"\"\"\n        # setOutput handles STAC catalog processing\n        self.setOutput(\"result\", {\n            \"stac\": results_path,\n            \"type\": \"application/json\"\n        })\n</code></pre>"},{"location":"user-guide/basic-usage/#pod-configuration","title":"Pod Configuration","text":"<p>Customize pod environment and node selection:</p> <pre><code>class MyExecutionHandler(CommonExecutionHandler):\n    def get_pod_env_vars(self):\n        \"\"\"Custom pod environment variables\"\"\"\n        env_vars = super().get_pod_env_vars()\n        env_vars.update({\n            \"CUSTOM_ENV\": \"value\",\n            \"API_KEY\": self.get_secret(\"api_key\")\n        })\n        return env_vars\n\n    def get_pod_node_selector(self):\n        \"\"\"Select specific nodes\"\"\"\n        return {\n            \"workload\": \"processing\",\n            \"gpu\": \"true\"\n        }\n</code></pre>"},{"location":"user-guide/basic-usage/#additional-parameters","title":"Additional Parameters","text":"<p>Add custom parameters to workflow execution:</p> <pre><code>class MyExecutionHandler(CommonExecutionHandler):\n    def get_additional_parameters(self):\n        \"\"\"Custom workflow parameters\"\"\"\n        params = super().get_additional_parameters()\n        params[\"max_cores\"] = 8\n        params[\"max_ram\"] = \"16G\"\n        return params\n</code></pre>"},{"location":"user-guide/basic-usage/#secrets-management","title":"Secrets Management","text":"<p>Load secrets from YAML files:</p> <pre><code>class MyExecutionHandler(CommonExecutionHandler):\n    def setup_credentials(self):\n        \"\"\"Load and use secrets\"\"\"\n        secrets = self.get_secrets()\n\n        api_key = secrets.get(\"api_key\")\n        db_password = secrets.get(\"db_password\")\n\n        # Use secrets\n        self.configure_api(api_key)\n        self.connect_database(db_password)\n</code></pre> <p>Secrets are loaded from: - <code>/var/etc/secrets/processing_secrets.yaml</code> - <code>/var/etc/zoo-services-user/processing_secrets.yaml</code></p>"},{"location":"user-guide/basic-usage/#complete-example","title":"Complete Example","text":"<pre><code>from zoo_template_common import CommonExecutionHandler\nimport os\n\nclass ProcessingHandler(CommonExecutionHandler):\n    \"\"\"Handler for data processing workflows\"\"\"\n\n    def pre_execution_hook(self):\n        \"\"\"Setup processing environment\"\"\"\n        # Load secrets\n        secrets = self.get_secrets()\n        os.environ[\"S3_KEY\"] = secrets.get(\"s3_access_key\", \"\")\n        os.environ[\"S3_SECRET\"] = secrets.get(\"s3_secret_key\", \"\")\n\n        # Validate configuration\n        required = [\"input_data\", \"output_bucket\"]\n        for key in required:\n            if key not in self.conf[\"lenv\"]:\n                raise ValueError(f\"Missing required parameter: {key}\")\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Process results\"\"\"\n        # Setup S3 environment\n        super().post_execution_hook(log, output, usage_report, tool_logs)\n\n        # Log execution stats\n        self.log_stats(usage_report)\n\n        # Register tool logs\n        self.handle_outputs(log, output, usage_report, tool_logs)\n\n    def get_pod_env_vars(self):\n        \"\"\"Configure pod environment\"\"\"\n        env_vars = super().get_pod_env_vars()\n        env_vars[\"PROCESSING_MODE\"] = \"batch\"\n        env_vars[\"LOG_LEVEL\"] = \"INFO\"\n        return env_vars\n\n    def get_pod_node_selector(self):\n        \"\"\"Select compute nodes\"\"\"\n        return {\"node-type\": \"compute-optimized\"}\n\n    def get_additional_parameters(self):\n        \"\"\"Workflow parameters\"\"\"\n        return {\n            \"max_cores\": 16,\n            \"max_ram\": \"32G\",\n            \"timeout\": 3600\n        }\n\n    def log_stats(self, usage_report):\n        \"\"\"Log execution statistics\"\"\"\n        if usage_report:\n            print(f\"Execution time: {usage_report.get('duration', 'N/A')}\")\n            print(f\"Memory used: {usage_report.get('memory', 'N/A')}\")\n</code></pre>"},{"location":"user-guide/basic-usage/#error-handling","title":"Error Handling","text":"<p>Handle errors gracefully:</p> <pre><code>class MyExecutionHandler(CommonExecutionHandler):\n    def safe_execute(self):\n        \"\"\"Execute with error handling\"\"\"\n        try:\n            self.pre_execution_hook()\n            result = self.run_workflow()\n            self.post_execution_hook(None, result, None, None)\n            return True\n        except ValueError as e:\n            self.conf[\"lenv\"][\"message\"] = f\"Validation error: {e}\"\n            return False\n        except Exception as e:\n            self.conf[\"lenv\"][\"message\"] = f\"Execution failed: {e}\"\n            return False\n</code></pre>"},{"location":"user-guide/basic-usage/#next-steps","title":"Next Steps","text":"<ul> <li>Learn about extending the handler</li> <li>See complete examples</li> <li>Read the API reference</li> </ul>"},{"location":"user-guide/examples/","title":"Complete Examples","text":"<p>This page provides real-world examples of using <code>zoo-template-common</code> from production templates.</p>"},{"location":"user-guide/examples/#example-1-simple-handler-zoo-service-template","title":"Example 1: Simple Handler (zoo-service-template)","text":"<p>The zoo-service-template (EOAP) shows a minimal extension of <code>CommonExecutionHandler</code>:</p> <pre><code>from zoo_template_common import CommonExecutionHandler, CustomStacIO\nfrom zoo_calrissian_runner import ZooCalrissianRunner\nfrom pystac.stac_io import StacIO\nimport yaml\nimport os\n\n# Set custom STAC I/O for S3 operations\nStacIO.set_default(CustomStacIO)\n\n\nclass SimpleExecutionHandler(CommonExecutionHandler):\n    \"\"\"Simple execution handler for basic ZOO workflows.\n\n    Extends CommonExecutionHandler with specific storage platform configuration.\n    \"\"\"\n\n    def __init__(self, conf, outputs):\n        super().__init__(conf, outputs)\n\n    def get_additional_parameters(self):\n        \"\"\"Get additional parameters with eoap storage platform.\"\"\"\n        additional_parameters = super().get_additional_parameters()\n        additional_parameters[\"storage_platform\"] = \"eoap\"\n        return additional_parameters\n\n\ndef my_workflow(conf, inputs, outputs):\n    \"\"\"ZOO Service entry point\"\"\"\n    try:\n        # Load CWL workflow\n        with open(\"app-package.cwl\", \"r\") as stream:\n            cwl = yaml.safe_load(stream)\n\n        # Create execution handler\n        execution_handler = SimpleExecutionHandler(conf=conf, outputs=outputs)\n\n        # Create runner\n        runner = ZooCalrissianRunner(\n            cwl=cwl,\n            conf=conf,\n            inputs=inputs,\n            outputs=outputs,\n            execution_handler=execution_handler,\n        )\n\n        # Execute workflow\n        exit_status = runner.execute()\n        return exit_status\n\n    except Exception as e:\n        conf[\"lenv\"][\"message\"] = str(e)\n        return 4  # SERVICE_FAILED\n</code></pre> <p>Key points: - \u2705 Only 15 lines of custom code (vs 250+ lines before using zoo-template-common) - \u2705 Adds single parameter: <code>storage_platform = \"eoap\"</code> - \u2705 Inherits all functionality: STAC processing, pod config, secrets handling - \u2705 Clean and maintainable</p> <p>Repository: eoap/zoo-service-template</p>"},{"location":"user-guide/examples/#example-2-advanced-handler-with-workspace-integration-eoepca-proc-service-template","title":"Example 2: Advanced Handler with Workspace Integration (eoepca-proc-service-template)","text":"<p>The eoepca-proc-service-template shows a more complex extension with EOEPCA Workspace API integration:</p> <pre><code>from zoo_template_common import CommonExecutionHandler, CustomStacIO\nfrom zoo_calrissian_runner import ZooCalrissianRunner\nimport jwt\nimport requests\nimport os\n\nclass EoepcaCalrissianRunnerExecutionHandler(CommonExecutionHandler):\n    \"\"\"EOEPCA-specific execution handler with Workspace API integration.\"\"\"\n\n    def __init__(self, conf, outputs):\n        super().__init__(conf, outputs)\n        self.http_proxy_env = os.environ.get(\"HTTP_PROXY\", None)\n        self.username = None\n\n        # Get auth environment\n        auth_env = self.conf.get(\"auth_env\", {})\n        self.ades_rx_token = auth_env.get(\"jwt\", \"\")\n\n        # Get EOEPCA configuration\n        eoepca = self.conf.get(\"eoepca\", {})\n        self.workspace_url = eoepca.get(\"workspace_url\", \"\")\n        self.workspace_prefix = eoepca.get(\"workspace_prefix\", \"\")\n        self.workspace_catalog_register = (\n            eoepca.get(\"workspace_catalog_register\", \"false\").lower() == \"true\"\n        )\n\n        # Initialize stage-in/stage-out defaults\n        self.init_config_defaults(self.conf)\n\n    @staticmethod\n    def get_user_name(decodedJwt):\n        \"\"\"Extract username from JWT token.\"\"\"\n        for key in [\"username\", \"user_name\", \"preferred_username\"]:\n            if key in decodedJwt:\n                return decodedJwt[key]\n        return None\n\n    def pre_execution_hook(self):\n        \"\"\"Hook to run before execution with EOEPCA Workspace integration.\"\"\"\n        # Decode JWT token to get username\n        if self.ades_rx_token:\n            self.username = self.get_user_name(\n                jwt.decode(self.ades_rx_token, options={\"verify_signature\": False})\n            )\n\n        # Lookup workspace storage details\n        if self.workspace_url and self.username:\n            workspace_api_endpoint = os.path.join(\n                self.workspace_url,\n                f\"workspaces/{self.workspace_prefix}-{self.username}\"\n            )\n\n            headers = {\"accept\": \"application/json\"}\n            if self.ades_rx_token:\n                headers[\"Authorization\"] = f\"Bearer {self.ades_rx_token}\"\n\n            response = requests.get(workspace_api_endpoint, headers=headers)\n\n            if response.ok:\n                workspace_data = response.json()\n                storage_credentials = workspace_data[\"storage\"][\"credentials\"]\n\n                # Update stage-out configuration with user's workspace credentials\n                self.conf[\"additional_parameters\"].update({\n                    \"STAGEOUT_AWS_SERVICEURL\": storage_credentials.get(\"endpoint\"),\n                    \"STAGEOUT_AWS_ACCESS_KEY_ID\": storage_credentials.get(\"access\"),\n                    \"STAGEOUT_AWS_SECRET_ACCESS_KEY\": storage_credentials.get(\"secret\"),\n                    \"STAGEOUT_AWS_REGION\": storage_credentials.get(\"region\"),\n                    \"STAGEOUT_OUTPUT\": workspace_data[\"storage\"].get(\"buckets\", {}).get(\"outputs\")\n                })\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Process results and register to Workspace Catalogue.\"\"\"\n        # Call parent to setup S3 environment\n        super().post_execution_hook(log, output, usage_report, tool_logs)\n\n        # Register outputs to Workspace Catalogue if configured\n        if self.workspace_catalog_register and self.username:\n            self.register_to_workspace_catalogue(output)\n\n    def register_to_workspace_catalogue(self, output):\n        \"\"\"Register STAC catalog to Workspace Catalogue.\"\"\"\n        stac_catalog_url = output.get(\"stac\")\n        if not stac_catalog_url:\n            return\n\n        register_endpoint = os.path.join(\n            self.workspace_url,\n            f\"workspaces/{self.workspace_prefix}-{self.username}/register\"\n        )\n\n        headers = {\n            \"accept\": \"application/json\",\n            \"Content-Type\": \"application/json\"\n        }\n        if self.ades_rx_token:\n            headers[\"Authorization\"] = f\"Bearer {self.ades_rx_token}\"\n\n        payload = {\"stac_catalog_uri\": stac_catalog_url}\n\n        response = requests.post(register_endpoint, headers=headers, json=payload)\n        if response.ok:\n            logger.info(\"Successfully registered outputs to Workspace Catalogue\")\n        else:\n            logger.warning(f\"Failed to register outputs: {response.text}\")\n\n\ndef my_workflow(conf, inputs, outputs):\n    \"\"\"ZOO Service with EOEPCA integration\"\"\"\n    try:\n        # Load CWL workflow\n        with open(\"app-package.cwl\", \"r\") as stream:\n            cwl = yaml.safe_load(stream)\n\n        # Create EOEPCA handler\n        execution_handler = EoepcaCalrissianRunnerExecutionHandler(\n            conf=conf, \n            outputs=outputs\n        )\n\n        # Create runner\n        runner = ZooCalrissianRunner(\n            cwl=cwl,\n            conf=conf,\n            inputs=inputs,\n            outputs=outputs,\n            execution_handler=execution_handler,\n        )\n\n        # Execute workflow\n        exit_status = runner.execute()\n        return exit_status\n\n    except Exception as e:\n        conf[\"lenv\"][\"message\"] = str(e)\n        return 4  # SERVICE_FAILED\n</code></pre> <p>Key features: - \u2705 JWT token authentication and user extraction - \u2705 Dynamic Workspace API integration for storage credentials - \u2705 Automatic stage-out to user's workspace bucket - \u2705 STAC catalog registration to Workspace Catalogue - \u2705 HTTP proxy management for network operations - \u2705 Fallback to environment variables for configuration</p> <p>Repository: EOEPCA/eoepca-proc-service-template</p>"},{"location":"user-guide/examples/#comparison-simple-vs-advanced","title":"Comparison: Simple vs Advanced","text":"Feature SimpleExecutionHandler EoepcaCalrissianRunnerExecutionHandler Lines of code ~15 ~200 Code reduction 62% vs original Still complex but organized Authentication None JWT token decoding Storage Static configuration Dynamic from Workspace API Catalog registration No Yes, to Workspace Catalogue Use case Basic workflows Multi-tenant EOEPCA platform"},{"location":"user-guide/examples/#running-the-examples","title":"Running the Examples","text":""},{"location":"user-guide/examples/#prerequisites","title":"Prerequisites","text":"<pre><code># Install dependencies\npip install zoo-template-common\npip install zoo-calrissian-runner  # or zoo-argowf-runner, zoo-wes-runner\n</code></pre>"},{"location":"user-guide/examples/#configuration","title":"Configuration","text":""},{"location":"user-guide/examples/#configuration_1","title":"Configuration","text":"<p>For SimpleExecutionHandler (zoo-service-template):</p> <pre><code>conf = {\n    \"lenv\": {\n        \"usid\": \"unique-execution-id\",\n        \"Identifier\": \"my-workflow\"\n    },\n    \"main\": {\n        \"tmpPath\": \"/tmp/zoo\"\n    },\n    \"additional_parameters\": {\n        # S3 configuration\n        \"aws_access_key_id\": \"ACCESS_KEY\",\n        \"aws_secret_access_key\": \"SECRET_KEY\",\n        \"endpoint_url\": \"https://s3.example.com\",\n        \"region_name\": \"us-east-1\"\n    }\n}\n</code></pre> <p>For EoepcaCalrissianRunnerExecutionHandler (eoepca-proc-service-template):</p> <pre><code>conf = {\n    \"lenv\": {\n        \"usid\": \"unique-execution-id\",\n        \"Identifier\": \"my-workflow\"\n    },\n    \"main\": {\n        \"tmpPath\": \"/tmp/zoo\"\n    },\n    \"auth_env\": {\n        \"jwt\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...\"  # JWT token\n    },\n    \"eoepca\": {\n        \"domain\": \"demo.eoepca.org\",\n        \"workspace_url\": \"https://workspace-api.demo.eoepca.org\",\n        \"workspace_prefix\": \"ws\",\n        \"workspace_catalog_register\": \"true\"\n    },\n    \"additional_parameters\": {\n        # Stage-in defaults\n        \"STAGEIN_AWS_SERVICEURL\": \"https://s3-stagein.example.com\",\n        \"STAGEIN_AWS_ACCESS_KEY_ID\": \"STAGEIN_KEY\",\n        \"STAGEIN_AWS_SECRET_ACCESS_KEY\": \"STAGEIN_SECRET\",\n        \"STAGEIN_AWS_REGION\": \"us-east-1\",\n\n        # Stage-out will be overridden by Workspace API\n        \"STAGEOUT_AWS_SERVICEURL\": \"https://s3-stageout.example.com\",\n        \"STAGEOUT_AWS_ACCESS_KEY_ID\": \"STAGEOUT_KEY\",\n        \"STAGEOUT_AWS_SECRET_ACCESS_KEY\": \"STAGEOUT_SECRET\",\n        \"STAGEOUT_AWS_REGION\": \"us-east-1\",\n        \"STAGEOUT_OUTPUT\": \"workspace-bucket\"\n    }\n}\n</code></pre>"},{"location":"user-guide/examples/#architecture-diagrams","title":"Architecture Diagrams","text":""},{"location":"user-guide/examples/#simpleexecutionhandler-flow","title":"SimpleExecutionHandler Flow","text":"<pre><code>User Request\n    \u2193\nSimpleExecutionHandler\n    \u251c\u2500\u2500 get_additional_parameters() \u2192 Add \"storage_platform\"\n    \u2514\u2500\u2500 Inherit all from CommonExecutionHandler\n        \u251c\u2500\u2500 STAC processing\n        \u251c\u2500\u2500 Pod configuration\n        \u2514\u2500\u2500 S3 environment setup\n    \u2193\nZooCalrissianRunner\n    \u2193\nKubernetes Job (Calrissian)\n    \u2193\nResults \u2192 STAC Catalog\n</code></pre>"},{"location":"user-guide/examples/#eoepcacalrissianrunnerexecutionhandler-flow","title":"EoepcaCalrissianRunnerExecutionHandler Flow","text":"<pre><code>User Request (with JWT)\n    \u2193\nEoepcaCalrissianRunnerExecutionHandler\n    \u251c\u2500\u2500 pre_execution_hook()\n    \u2502   \u251c\u2500\u2500 Decode JWT \u2192 Extract username\n    \u2502   \u251c\u2500\u2500 Call Workspace API \u2192 Get storage credentials\n    \u2502   \u2514\u2500\u2500 Update stage-out configuration\n    \u251c\u2500\u2500 Inherit STAC processing from CommonExecutionHandler\n    \u2514\u2500\u2500 post_execution_hook()\n        \u251c\u2500\u2500 Setup S3 environment (parent)\n        \u2514\u2500\u2500 Register catalog to Workspace Catalogue\n    \u2193\nZooCalrissianRunner\n    \u2193\nKubernetes Job (Calrissian)\n    \u251c\u2500\u2500 Stage-in from public S3\n    \u2514\u2500\u2500 Stage-out to user's workspace bucket\n    \u2193\nResults \u2192 User's STAC Catalog \u2192 Registered in Workspace\n</code></pre>"},{"location":"user-guide/examples/#best-practices-from-real-templates","title":"Best Practices from Real Templates","text":""},{"location":"user-guide/examples/#1-keep-simple-handlers-simple","title":"1. Keep Simple Handlers Simple","text":"<p>From zoo-service-template: <pre><code># \u2705 DO: Minimal override\nclass SimpleExecutionHandler(CommonExecutionHandler):\n    def get_additional_parameters(self):\n        params = super().get_additional_parameters()\n        params[\"storage_platform\"] = \"eoap\"\n        return params\n\n# \u274c DON'T: Reimplement everything\nclass BadHandler(CommonExecutionHandler):\n    def __init__(self, conf, outputs):\n        # Don't reimplement all the base logic\n        pass\n</code></pre></p>"},{"location":"user-guide/examples/#2-use-hooks-appropriately","title":"2. Use Hooks Appropriately","text":"<p>From eoepca-proc-service-template: <pre><code># \u2705 DO: Use pre_execution_hook for setup\ndef pre_execution_hook(self):\n    self.username = self.extract_user_from_jwt()\n    self.fetch_workspace_credentials()\n\n# \u2705 DO: Use post_execution_hook for finalization\ndef post_execution_hook(self, log, output, usage_report, tool_logs):\n    super().post_execution_hook(log, output, usage_report, tool_logs)\n    self.register_to_catalogue(output)\n\n# \u274c DON'T: Put everything in __init__\n</code></pre></p>"},{"location":"user-guide/examples/#3-handle-secrets-securely","title":"3. Handle Secrets Securely","text":"<pre><code># \u2705 DO: Use get_secrets() method\ndef pre_execution_hook(self):\n    secrets = self.get_secrets()\n    api_key = secrets.get(\"api_key\")\n\n# \u274c DON'T: Hardcode credentials\n</code></pre>"},{"location":"user-guide/examples/#4-set-custom-stac-io","title":"4. Set Custom STAC I/O","text":"<p>Both templates use this pattern: <pre><code>from pystac.stac_io import StacIO\nfrom zoo_template_common import CustomStacIO\n\n# Set once at module level\nStacIO.set_default(CustomStacIO)\n</code></pre></p>"},{"location":"user-guide/examples/#testing-your-handler","title":"Testing Your Handler","text":""},{"location":"user-guide/examples/#unit-test-example","title":"Unit Test Example","text":"<pre><code>import pytest\nfrom your_service import SimpleExecutionHandler\n\ndef test_simple_handler():\n    \"\"\"Test SimpleExecutionHandler\"\"\"\n    conf = {\n        \"lenv\": {\"message\": \"\"},\n        \"additional_parameters\": {}\n    }\n    outputs = {}\n\n    handler = SimpleExecutionHandler(conf, outputs)\n    params = handler.get_additional_parameters()\n\n    assert \"storage_platform\" in params\n    assert params[\"storage_platform\"] == \"eoap\"\n\ndef test_eoepca_handler_jwt():\n    \"\"\"Test EOEPCA handler with JWT\"\"\"\n    conf = {\n        \"lenv\": {},\n        \"auth_env\": {\"jwt\": \"valid.jwt.token\"},\n        \"eoepca\": {\n            \"workspace_url\": \"https://workspace-api.example.com\",\n            \"workspace_prefix\": \"ws\"\n        },\n        \"additional_parameters\": {}\n    }\n    outputs = {}\n\n    handler = EoepcaCalrissianRunnerExecutionHandler(conf, outputs)\n    # Mock the requests.get call\n    # Test that username is extracted correctly\n    # Test that credentials are updated\n</code></pre>"},{"location":"user-guide/examples/#additional-resources","title":"Additional Resources","text":"<ul> <li>zoo-service-template: github.com/eoap/zoo-service-template</li> <li>eoepca-proc-service-template: github.com/EOEPCA/eoepca-proc-service-template</li> <li>Integration Guides: See <code>INTEGRATION_ZOO_TEMPLATE_COMMON.md</code> and <code>TEMPLATE_INTEGRATION.md</code> in respective repositories</li> </ul>"},{"location":"user-guide/examples/#next-steps","title":"Next Steps","text":"<ul> <li>Review the API Reference</li> <li>Learn about CustomStacIO</li> <li>Read Extending the Handler for more patterns</li> </ul>"},{"location":"user-guide/extending/","title":"Extending CommonExecutionHandler","text":"<p>This guide shows how to extend <code>CommonExecutionHandler</code> for specialized use cases.</p>"},{"location":"user-guide/extending/#extension-patterns","title":"Extension Patterns","text":""},{"location":"user-guide/extending/#1-authentication-handler","title":"1. Authentication Handler","text":"<p>Add authentication to your workflows:</p> <pre><code>from zoo_template_common import CommonExecutionHandler\nimport jwt\nimport requests\n\nclass AuthenticatedHandler(CommonExecutionHandler):\n    \"\"\"Handler with JWT authentication\"\"\"\n\n    def __init__(self, conf, outputs=None):\n        super().__init__(conf, outputs)\n        self.token = None\n        self.username = None\n\n    def pre_execution_hook(self):\n        \"\"\"Extract and validate JWT token\"\"\"\n        # Get token from environment or conf\n        token_str = os.environ.get(\"ACCESS_TOKEN\") or \\\n                    self.conf[\"lenv\"].get(\"access_token\")\n\n        if not token_str:\n            raise ValueError(\"No access token provided\")\n\n        # Decode JWT\n        try:\n            self.token = jwt.decode(token_str, options={\"verify_signature\": False})\n            self.username = self.token.get(\"preferred_username\", \"unknown\")\n        except Exception as e:\n            raise ValueError(f\"Invalid token: {e}\")\n\n        # Setup user-specific environment\n        self.setup_user_environment()\n\n    def setup_user_environment(self):\n        \"\"\"Configure environment for user\"\"\"\n        os.environ[\"CURRENT_USER\"] = self.username\n        os.environ[\"USER_WORKSPACE\"] = f\"/workspaces/{self.username}\"\n</code></pre>"},{"location":"user-guide/extending/#2-workspace-integration","title":"2. Workspace Integration","text":"<p>Integrate with external workspace APIs:</p> <pre><code>class WorkspaceHandler(AuthenticatedHandler):\n    \"\"\"Handler with workspace integration\"\"\"\n\n    def __init__(self, conf, outputs=None):\n        super().__init__(conf, outputs)\n        self.workspace_api = None\n\n    def pre_execution_hook(self):\n        \"\"\"Setup workspace connection\"\"\"\n        super().pre_execution_hook()\n\n        # Connect to workspace API\n        workspace_url = os.environ.get(\"WORKSPACE_API_URL\")\n        self.workspace_api = WorkspaceClient(workspace_url, self.token)\n\n        # Get storage credentials\n        credentials = self.workspace_api.get_credentials(self.username)\n        self.configure_storage(credentials)\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Register results in workspace\"\"\"\n        super().post_execution_hook(log, output, usage_report, tool_logs)\n\n        # Register output catalog\n        if \"stac_catalog\" in output:\n            self.workspace_api.register_catalog(\n                username=self.username,\n                catalog_url=output[\"stac_catalog\"]\n            )\n\n    def configure_storage(self, credentials):\n        \"\"\"Configure S3 storage\"\"\"\n        os.environ[\"AWS_ACCESS_KEY_ID\"] = credentials[\"access_key\"]\n        os.environ[\"AWS_SECRET_ACCESS_KEY\"] = credentials[\"secret_key\"]\n        os.environ[\"AWS_S3_ENDPOINT\"] = credentials[\"endpoint\"]\n</code></pre>"},{"location":"user-guide/extending/#3-custom-stac-processing","title":"3. Custom STAC Processing","text":"<p>Override STAC processing behavior:</p> <pre><code>class CustomStacHandler(CommonExecutionHandler):\n    \"\"\"Handler with custom STAC processing\"\"\"\n\n    def setOutput(self, outputName, values):\n        \"\"\"Custom STAC processing\"\"\"\n        # Pre-process values\n        if \"stac\" in values:\n            values = self.enhance_stac_catalog(values)\n\n        # Call parent\n        super().setOutput(outputName, values)\n\n        # Post-process\n        self.publish_catalog(outputName)\n\n    def enhance_stac_catalog(self, values):\n        \"\"\"Add metadata to STAC items\"\"\"\n        catalog_path = values.get(\"stac\")\n\n        # Load catalog\n        from pystac import Catalog\n        catalog = Catalog.from_file(catalog_path)\n\n        # Add custom metadata\n        for item in catalog.get_items():\n            item.properties[\"processor\"] = \"custom-processor\"\n            item.properties[\"version\"] = \"1.0.0\"\n            item.properties[\"user\"] = getattr(self, \"username\", \"unknown\")\n\n        # Save enhanced catalog\n        catalog.save()\n\n        return values\n\n    def publish_catalog(self, output_name):\n        \"\"\"Publish catalog to external service\"\"\"\n        print(f\"Publishing {output_name} to catalog service\")\n</code></pre>"},{"location":"user-guide/extending/#4-monitoring-and-metrics","title":"4. Monitoring and Metrics","text":"<p>Add monitoring capabilities:</p> <pre><code>class MonitoredHandler(CommonExecutionHandler):\n    \"\"\"Handler with monitoring\"\"\"\n\n    def __init__(self, conf, outputs=None):\n        super().__init__(conf, outputs)\n        self.metrics = {}\n        self.start_time = None\n\n    def pre_execution_hook(self):\n        \"\"\"Start monitoring\"\"\"\n        import time\n        self.start_time = time.time()\n        self.metrics[\"status\"] = \"started\"\n        self.send_metric(\"workflow.started\", 1)\n\n        super().pre_execution_hook()\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Record metrics\"\"\"\n        import time\n        duration = time.time() - self.start_time\n\n        self.metrics[\"duration\"] = duration\n        self.metrics[\"status\"] = \"completed\"\n\n        super().post_execution_hook(log, output, usage_report, tool_logs)\n\n        # Send metrics\n        self.send_metric(\"workflow.duration\", duration)\n        self.send_metric(\"workflow.completed\", 1)\n\n        if usage_report:\n            self.send_usage_metrics(usage_report)\n\n    def send_metric(self, name, value):\n        \"\"\"Send metric to monitoring system\"\"\"\n        # Implement your metrics backend\n        print(f\"METRIC {name}={value}\")\n\n    def send_usage_metrics(self, usage_report):\n        \"\"\"Send resource usage metrics\"\"\"\n        for key, value in usage_report.items():\n            self.send_metric(f\"resource.{key}\", value)\n</code></pre>"},{"location":"user-guide/extending/#5-multi-backend-storage","title":"5. Multi-Backend Storage","text":"<p>Support multiple storage backends:</p> <pre><code>class MultiStorageHandler(CommonExecutionHandler):\n    \"\"\"Handler supporting multiple storage backends\"\"\"\n\n    def get_pod_env_vars(self):\n        \"\"\"Configure multiple storage backends\"\"\"\n        env_vars = super().get_pod_env_vars()\n\n        # Primary S3 storage\n        env_vars[\"PRIMARY_S3_ENDPOINT\"] = os.environ.get(\"S3_ENDPOINT\")\n        env_vars[\"PRIMARY_S3_BUCKET\"] = os.environ.get(\"S3_BUCKET\")\n\n        # Secondary storage (e.g., Google Cloud)\n        if os.environ.get(\"GCS_BUCKET\"):\n            env_vars[\"GCS_BUCKET\"] = os.environ[\"GCS_BUCKET\"]\n            env_vars[\"GOOGLE_APPLICATION_CREDENTIALS\"] = \"/secrets/gcs-key.json\"\n\n        # Azure storage\n        if os.environ.get(\"AZURE_STORAGE_ACCOUNT\"):\n            env_vars[\"AZURE_STORAGE_ACCOUNT\"] = os.environ[\"AZURE_STORAGE_ACCOUNT\"]\n            env_vars[\"AZURE_STORAGE_KEY\"] = self.get_secrets().get(\"azure_key\")\n\n        return env_vars\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Replicate outputs to multiple backends\"\"\"\n        super().post_execution_hook(log, output, usage_report, tool_logs)\n\n        # Replicate to secondary storage\n        if os.environ.get(\"GCS_BUCKET\"):\n            self.replicate_to_gcs(output)\n\n        if os.environ.get(\"AZURE_STORAGE_ACCOUNT\"):\n            self.replicate_to_azure(output)\n</code></pre>"},{"location":"user-guide/extending/#6-validation-and-quality-control","title":"6. Validation and Quality Control","text":"<p>Add validation steps:</p> <pre><code>class ValidatedHandler(CommonExecutionHandler):\n    \"\"\"Handler with validation\"\"\"\n\n    def pre_execution_hook(self):\n        \"\"\"Validate inputs\"\"\"\n        super().pre_execution_hook()\n\n        # Validate required inputs\n        self.validate_inputs()\n\n        # Validate resources\n        self.validate_resources()\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Validate outputs\"\"\"\n        super().post_execution_hook(log, output, usage_report, tool_logs)\n\n        # Validate output quality\n        if not self.validate_outputs(output):\n            raise ValueError(\"Output validation failed\")\n\n        # Check STAC compliance\n        self.validate_stac_catalog(output)\n\n    def validate_inputs(self):\n        \"\"\"Validate input parameters\"\"\"\n        required = [\"input_data\", \"output_path\"]\n        for param in required:\n            if param not in self.conf[\"lenv\"]:\n                raise ValueError(f\"Missing required parameter: {param}\")\n\n    def validate_outputs(self, output):\n        \"\"\"Validate output data\"\"\"\n        # Check output exists\n        if not output or not output.get(\"stac\"):\n            return False\n\n        # Validate file exists\n        import os\n        if not os.path.exists(output[\"stac\"]):\n            return False\n\n        return True\n\n    def validate_stac_catalog(self, output):\n        \"\"\"Validate STAC catalog structure\"\"\"\n        from pystac import Catalog\n\n        try:\n            catalog = Catalog.from_file(output[\"stac\"])\n            catalog.validate()\n        except Exception as e:\n            raise ValueError(f\"Invalid STAC catalog: {e}\")\n</code></pre>"},{"location":"user-guide/extending/#combining-extensions","title":"Combining Extensions","text":"<p>Combine multiple extensions using multiple inheritance:</p> <pre><code>class FullFeaturedHandler(\n    MonitoredHandler,\n    WorkspaceHandler,\n    ValidatedHandler\n):\n    \"\"\"Handler with all features\"\"\"\n\n    def pre_execution_hook(self):\n        \"\"\"Combined pre-execution\"\"\"\n        # Call all parent hooks\n        MonitoredHandler.pre_execution_hook(self)\n        WorkspaceHandler.pre_execution_hook(self)\n        ValidatedHandler.pre_execution_hook(self)\n\n    def post_execution_hook(self, log, output, usage_report, tool_logs):\n        \"\"\"Combined post-execution\"\"\"\n        # Call all parent hooks\n        ValidatedHandler.post_execution_hook(self, log, output, usage_report, tool_logs)\n        WorkspaceHandler.post_execution_hook(self, log, output, usage_report, tool_logs)\n        MonitoredHandler.post_execution_hook(self, log, output, usage_report, tool_logs)\n</code></pre>"},{"location":"user-guide/extending/#best-practices","title":"Best Practices","text":"<ol> <li>Always call parent methods: Use <code>super()</code> to ensure base functionality</li> <li>Handle errors gracefully: Wrap operations in try-except blocks</li> <li>Document your extensions: Add clear docstrings</li> <li>Keep it simple: Don't over-engineer</li> <li>Test thoroughly: Write unit tests for custom logic</li> </ol>"},{"location":"user-guide/extending/#next-steps","title":"Next Steps","text":"<ul> <li>See complete examples</li> <li>Read the API reference</li> <li>Learn about CustomStacIO</li> </ul>"}]}